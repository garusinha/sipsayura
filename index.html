<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sipsayura Cloud - V26</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <style>
      :root { --p: #4f46e5; --s: #10b981; --d: #ef4444; --dk: #0f172a; --bg: #f1f5f9; }
      body { font-family: "Plus Jakarta Sans", sans-serif; margin: 0; background: var(--bg); color: var(--dk); }
      header { background: var(--dk); color: white; padding: 25px; text-align: center; border-bottom: 5px solid var(--p); }
      nav { background: white; padding: 12px; display: flex; justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      .nav-btn { padding: 12px 20px; border-radius: 12px; font-weight: 700; border: none; background: transparent; color: #64748b; cursor: pointer; }
      .nav-btn.active { background: var(--p); color: white; }
      .container { padding: 15px; max-width: 600px; margin: auto; padding-bottom: 100px; }
      .card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
      input { width: 100%; padding: 14px; border-radius: 14px; border: 2px solid #e2e8f0; font-size: 1rem; box-sizing: border-box; margin-bottom: 15px; }
      .std-row { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: 18px; margin-bottom: 8px; border: 1px solid #f1f5f9; }
      .btn { border: none; padding: 16px; border-radius: 14px; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; margin-top: 10px; }
      .btn-p { background: var(--p); color: white; }
      .btn-dk { background: var(--dk); color: white; }
      .btn-s { background: var(--s); color: white; }
      .overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 3000; padding: 20px; overflow-y: auto; backdrop-filter: blur(10px); }
      .modal { background: white; max-width: 500px; margin: 20px auto; border-radius: 32px; padding: 25px; }
      .finance-box { padding: 15px; background: var(--dk); color: white; border-radius: 18px; margin-top: 15px; font-size: 0.9rem; }
      .reject-btn { background: #fee2e2; color: #ef4444; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; cursor: pointer; }
    </style>
  </head>
  <body>

    <header>
      <span style="font-size: 2rem">üöÄ</span>
      <h1 style="margin: 0">SIPSAYURA <span style="color: var(--p)">CLOUD</span></h1>
      <small>Live Dual-Phone Sync Active</small>
    </header>

    <nav id="app-nav" style="display: none">
      <button class="nav-btn active" onclick="setTab('att', this)">Attendance</button>
      <button class="nav-btn" onclick="setTab('reg', this)">Register</button>
      <button class="nav-btn" onclick="setTab('set', this)">Settings</button>
    </nav>

    <div class="container">
      <div id="v-grades">
        <h2 style="text-align: center; margin: 40px 0">Select Grade</h2>
        <div id="dom-grades" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px"></div>
      </div>

      <div id="v-subs" style="display: none">
        <h2 id="lbl-grade" style="text-align: center"></h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px">
          <button class="card" onclick="enter('MATH')">üìê Math</button>
          <button class="card" onclick="enter('SCI')">üî¨ Science</button>
          <button class="card" onclick="enter('SIN')">‚úçÔ∏è Sinhala</button>
          <button class="card" onclick="enter('ENG')">üî§ English</button>
        </div>
      </div>

      <div id="v-dash" style="display: none">
        <div id="tab-att">
          <div class="card">
            <input type="date" id="att-date" onchange="render()" />
            <input type="text" id="att-q" placeholder="Search student..." oninput="render()" />
          </div>
          <button class="btn btn-dk" onclick="openSummaryWindow()">üìä View Daily Summary</button>
          <button class="btn btn-s" onclick="saveBulkAttendance()">‚úîÔ∏è Finalize Day</button>
          <div id="dom-list" style="margin-top: 20px"></div>
        </div>

        <div id="tab-reg" style="display: none">
          <div class="card">
            <h3>Enroll Student</h3>
            <label>Full Name</label>
            <input type="text" id="reg-n" placeholder="Ex: Kamal Perera" />
            <label>Phone Number</label>
            <input type="tel" id="reg-ph" placeholder="0712345678" />
            <button class="btn btn-p" onclick="register()">Add to Class</button>
          </div>
        </div>

        <div id="tab-set" style="display: none">
          <div class="card">
            <h3>Cloud Status</h3>
            <p style="color: var(--s)">üü¢ Syncing with sipsayura-96757</p>
            <button class="btn btn-dk" onclick="location.reload()">üîÑ Switch Grade/Exit</button>
          </div>
        </div>
      </div>
    </div>

    <div id="s-overlay" class="overlay">
      <div class="modal" style="max-width: 600px">
        <h2>Daily Summary</h2>
        <div id="sum-table-area" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px;"></div>
        <div class="finance-box" id="fin-box"></div>
        <button class="btn btn-p" onclick="shareSummary()">üì§ Download PDF</button>
        <button class="btn btn-dk" onclick="document.getElementById('s-overlay').style.display = 'none'">Close</button>
      </div>
    </div>

    <script>
      // --- FIREBASE SETUP ---
      const firebaseConfig = {
        apiKey: "AIzaSyARz6yYnI8d2KR6wWl--PT6nEnVikSplms",
        authDomain: "sipsayura-96757.firebaseapp.com",
        databaseURL: "https://sipsayura-96757-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sipsayura-96757",
        storageBucket: "sipsayura-96757.firebasestorage.app",
        messagingSenderId: "148140063507",
        appId: "1:148140063507:web:41a1046fa7aea4885238e6"
      };

      firebase.initializeApp(firebaseConfig);
      const rdb = firebase.database();

      let db = { students: [], att: {} };
      let cg = "", cs = "";

      // LISTEN FOR CHANGES (Update UI instantly)
      rdb.ref('sip_v26').on('value', (snapshot) => {
        const cloudData = snapshot.val();
        if (cloudData) {
          db = cloudData;
          if (document.getElementById("v-dash").style.display === "block") render();
        }
      });

      const saveDB = () => rdb.ref('sip_v26').set(db);

      // --- CORE LOGIC ---
      function init() {
        ["6", "7", "8", "9", "10", "11"].forEach(g => {
          document.getElementById("dom-grades").innerHTML += `<button class="card" onclick="selG('${g}')">Grade ${g}</button>`;
        });
      }

      function selG(g) {
        if (prompt("Enter PIN:") === "1234") {
          cg = String(g);
          document.getElementById("lbl-grade").innerText = "Grade " + g;
          showV("v-subs");
        }
      }

      function enter(s) {
        cs = String(s);
        showV("v-dash");
        document.getElementById("app-nav").style.display = "flex";
        setTab("att", document.querySelector(".nav-btn"));
      }

      function showV(id) {
        ["v-grades", "v-subs", "v-dash"].forEach(v => document.getElementById(v).style.display = "none");
        document.getElementById(id).style.display = "block";
      }

      function setTab(t, el) {
        ["att", "reg", "set"].forEach(i => document.getElementById("tab-" + i).style.display = "none");
        document.getElementById("tab-" + t).style.display = "block";
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        if (el) el.classList.add("active");
        if (t === "att") render();
      }

      function register() {
        const n = document.getElementById("reg-n").value, ph = document.getElementById("reg-ph").value;
        if (!n || !ph) return alert("Fill Name and Phone");
        
        if(!db.students) db.students = [];
        const id = `${cs}-${(db.students.filter(s => s.subject === cs).length + 1).toString().padStart(3, "0")}`;
        
        db.students.push({ id, name: n, phone: ph, grade: String(cg), subject: String(cs) });
        saveDB();
        
        alert("Student Registered to Cloud!");
        document.getElementById("reg-n").value = "";
        document.getElementById("reg-ph").value = "";
        setTab('att', document.querySelector('.nav-btn'));
      }

      function render() {
        const dateInput = document.getElementById("att-date").value;
        const date = dateInput || new Date().toISOString().split("T")[0];
        if(!dateInput) document.getElementById("att-date").value = date;

        const q = document.getElementById("att-q").value.toLowerCase();
        if(!db.students) db.students = [];

        // Critical Filter Fix
        const students = db.students.filter(s => 
          String(s.grade) === String(cg) && 
          String(s.subject) === String(cs) && 
          s.name.toLowerCase().includes(q)
        );

        const listDiv = document.getElementById("dom-list");
        if(students.length === 0) {
            listDiv.innerHTML = "<p style='text-align:center; color:gray'>No students found for this class.</p>";
            return;
        }

        const attData = (db.att && db.att[cs + cg + date]) || { present: [], rejected: {} };

        listDiv.innerHTML = students.map(s => {
          const isP = attData.present && attData.present.includes(s.id);
          const isR = attData.rejected && attData.rejected[s.id];
          return `<div class="std-row" style="${isR ? 'border-left: 5px solid red' : ''}">
            <div>
                <b>${s.name}</b><br>
                <small>${s.id} ${isR ? '‚ö†Ô∏è REJECTED' : ''}</small>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="reject-btn" onclick="toggleReject('${s.id}')">${isR ? 'Undo' : 'Reject'}</button>
                <input type="checkbox" style="width:30px; height:30px;" ${isP ? "checked" : ""} onchange="mark('${s.id}', this)">
            </div>
          </div>`;
        }).join("");
      }

      function mark(id, chk) {
        const date = document.getElementById("att-date").value;
        const key = cs + cg + date;
        if (!db.att) db.att = {};
        if (!db.att[key]) db.att[key] = { present: [], rejected: {} };
        
        if (chk.checked) {
          if(!db.att[key].present) db.att[key].present = [];
          if (!db.att[key].present.includes(id)) db.att[key].present.push(id);
        } else {
          db.att[key].present = db.att[key].present.filter(x => x !== id);
        }
        saveDB();
      }

      function toggleReject(id) {
        const date = document.getElementById("att-date").value;
        const key = cs + cg + date;
        if (!db.att) db.att = {};
        if (!db.att[key]) db.att[key] = { present: [], rejected: {} };
        if (!db.att[key].rejected) db.att[key].rejected = {};

        if (db.att[key].rejected[id]) {
            delete db.att[key].rejected[id];
        } else {
            const reason = prompt("Reason for rejection/return?");
            if (reason) db.att[key].rejected[id] = reason;
        }
        saveDB();
      }

      function saveBulkAttendance() {
        const date = document.getElementById("att-date").value;
        const key = cs + cg + date;
        if (!db.att[key]) db.att[key] = { present: [], rejected: {} };
        alert("Day Finalized and Saved to Cloud!");
      }

      function openSummaryWindow() {
        const date = document.getElementById("att-date").value;
        const key = cs + cg + date;
        const att = (db.att && db.att[key]) || { present: [], rejected: {} };
        const ss = db.students.filter(s => String(s.grade) === String(cg) && String(s.subject) === String(cs));
        
        let total = 0;
        let html = `<table id="report-table" style="width:100%; border-collapse: collapse; font-size: 0.8rem;">
            <thead><tr style="background:#eee"><th>Name</th><th>Status</th><th>Fee</th></tr></thead><tbody>`;
        
        ss.forEach(s => {
          const isP = att.present && att.present.includes(s.id);
          const isR = att.rejected && att.rejected[s.id];
          const amt = (isP && !isR) ? 1000 : 0;
          total += amt;
          html += `<tr style="border-bottom:1px solid #eee">
            <td>${s.name}${isR ? '<br><small style="color:red">Rejected: '+att.rejected[s.id]+'</small>' : ''}</td>
            <td style="color:${isP ? 'green' : 'red'}">${isP ? (isR ? 'REJ' : 'P') : 'A'}</td>
            <td>${amt}</td>
          </tr>`;
        });
        
        html += `</tbody></table>`;
        const inst = total * 0.2;
        document.getElementById("sum-table-area").innerHTML = html;
        document.getElementById("fin-box").innerHTML = `
            Cash Collected: Rs.${total} <br> 
            Inst. Fee (20%): Rs.${inst} <hr> 
            <b>Truck/Teacher Balance: Rs.${total - inst}</b>`;
        document.getElementById("s-overlay").style.display = "block";
      }

      function shareSummary() {
        const doc = new jspdf.jsPDF();
        doc.text("SIPSAYURA DAILY REPORT", 10, 10);
        doc.autoTable({ html: "#report-table", startY: 20 });
        doc.save("Daily_Report.pdf");
      }

      init();
    </script>
  </body>
</html>
