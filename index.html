<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sipsayura App - Cloud Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <style>
      :root { --p: #4f46e5; --s: #10b981; --d: #ef4444; --dk: #0f172a; --bg: #f1f5f9; }
      body { font-family: "Plus Jakarta Sans", sans-serif; margin: 0; background: var(--bg); color: var(--dk); }
      header { background: var(--dk); color: white; padding: 25px; text-align: center; border-bottom: 5px solid var(--p); }
      nav { background: white; padding: 12px; display: flex; justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      .nav-btn { padding: 12px 20px; border-radius: 12px; font-weight: 700; border: none; background: transparent; color: #64748b; cursor: pointer; }
      .nav-btn.active { background: var(--p); color: white; }
      .container { padding: 15px; max-width: 600px; margin: auto; padding-bottom: 100px; }
      .card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
      input { width: 100%; padding: 14px; border-radius: 14px; border: 2px solid #e2e8f0; font-size: 1rem; box-sizing: border-box; margin-bottom: 15px; }
      .std-row { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: 18px; margin-bottom: 8px; border: 1px solid #f1f5f9; }
      .btn { border: none; padding: 16px; border-radius: 14px; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; margin-top: 10px; }
      .btn-p { background: var(--p); color: white; }
      .btn-dk { background: var(--dk); color: white; }
      .btn-s { background: var(--s); color: white; }
      .overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 3000; padding: 20px; overflow-y: auto; backdrop-filter: blur(10px); }
      .modal { background: white; max-width: 500px; margin: 20px auto; border-radius: 32px; padding: 25px; }
      .finance-box { padding: 15px; background: var(--dk); color: white; border-radius: 18px; margin-top: 15px; font-size: 0.9rem; }
      .status-p { color: #10b981; font-weight: 800; }
      .status-a { color: #ef4444; font-weight: 800; }
    </style>
  </head>
  <body>

    <header>
      <span style="font-size: 2.5rem">üè´</span>
      <h1 style="margin: 0">SIPSAYURA <span style="color: var(--p)">CLOUD</span></h1>
      <small>V26 | Connected: sipsayura-96757</small>
    </header>

    <nav id="app-nav" style="display: none">
      <button class="nav-btn active" onclick="setTab('att', this)">Attendance</button>
      <button class="nav-btn" onclick="setTab('reg', this)">Register</button>
      <button class="nav-btn" onclick="setTab('set', this)">Settings</button>
    </nav>

    <div class="container">
      <div id="v-grades">
        <h2 style="text-align: center; margin: 40px 0">Select Grade</h2>
        <div id="dom-grades" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px"></div>
      </div>

      <div id="v-subs" style="display: none">
        <h2 id="lbl-grade" style="text-align: center"></h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px">
          <button class="card" onclick="enter('MATH')">üìê Math</button>
          <button class="card" onclick="enter('SCI')">üî¨ Science</button>
          <button class="card" onclick="enter('SIN')">‚úçÔ∏è Sinhala</button>
          <button class="card" onclick="enter('ENG')">üî§ English</button>
        </div>
      </div>

      <div id="v-dash" style="display: none">
        <div id="tab-att">
          <div class="card">
            <input type="date" id="att-date" onchange="render()" />
            <input type="text" id="att-q" placeholder="Search student..." oninput="render()" />
          </div>
          <button class="btn btn-dk" onclick="openSummaryWindow()">üìä View Daily Summary</button>
          <button class="btn btn-s" onclick="saveBulkAttendance()">‚úîÔ∏è Finalize Day</button>
          <div id="dom-list" style="margin-top: 20px"></div>
        </div>

        <div id="tab-reg" style="display: none">
          <div class="card">
            <h3>Enroll Student</h3>
            <input type="text" id="reg-n" placeholder="Full Name" />
            <input type="tel" id="reg-ph" placeholder="07XXXXXXXX" />
            <button class="btn btn-p" onclick="register()">Add to Class</button>
          </div>
        </div>

        <div id="tab-set" style="display: none">
          <div class="card">
            <h3>Cloud Settings</h3>
            <p id="sync-status" style="color: var(--s); font-weight: bold;">üü¢ Cloud Active</p>
            <button class="btn btn-dk" onclick="location.reload()">üîÑ Switch Grade</button>
          </div>
        </div>
      </div>
    </div>

    <div id="s-overlay" class="overlay">
      <div class="modal" style="max-width: 600px">
        <h2>Class Summary</h2>
        <div id="sum-table-area" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px;"></div>
        <div class="finance-box" id="fin-box"></div>
        <button class="btn btn-p" onclick="shareSummary()">üì§ Share PDF</button>
        <button class="btn btn-dk" onclick="document.getElementById('s-overlay').style.display = 'none'">Close</button>
      </div>
    </div>

    <script>
      // --- INTEGRATED FIREBASE CONFIG ---
      const firebaseConfig = {
        apiKey: "AIzaSyARz6yYnI8d2KR6wWl--PT6nEnVikSplms",
        authDomain: "sipsayura-96757.firebaseapp.com",
        databaseURL: "https://sipsayura-96757-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sipsayura-96757",
        storageBucket: "sipsayura-96757.firebasestorage.app",
        messagingSenderId: "148140063507",
        appId: "1:148140063507:web:41a1046fa7aea4885238e6",
        measurementId: "G-JS2G6LK70K"
      };

      // Initialize
      firebase.initializeApp(firebaseConfig);
      const rdb = firebase.database();
      if(firebaseConfig.measurementId) firebase.analytics();

      let db = { students: [], att: {}, fees: {} };
      let cg = "", cs = "";

      // REAL-TIME SYNC ENGINE
      rdb.ref('sip_v26').on('value', (snapshot) => {
        const cloudData = snapshot.val();
        if (cloudData) {
          db = cloudData;
          // Refresh UI automatically if data changes from another phone
          if (document.getElementById("v-dash").style.display === "block") render();
        }
      });

      const saveDB = () => rdb.ref('sip_v26').set(db);

      // --- APP FUNCTIONS ---
      function init() {
        ["6", "7", "8", "9", "10", "11"].forEach((g) => {
          document.getElementById("dom-grades").innerHTML += `<button class="card" onclick="selG('${g}')">Grade ${g}</button>`;
        });
      }

      function selG(g) {
        if (prompt("PIN:") === "1234") {
          cg = g;
          document.getElementById("lbl-grade").innerText = "Grade " + g;
          showV("v-subs");
        }
      }

      function enter(s) {
        cs = s;
        showV("v-dash");
        document.getElementById("app-nav").style.display = "flex";
        setTab("att", document.querySelector(".nav-btn"));
      }

      function showV(id) {
        ["v-grades", "v-subs", "v-dash"].forEach(v => document.getElementById(v).style.display = "none");
        document.getElementById(id).style.display = "block";
      }

      function setTab(t, el) {
        ["att", "reg", "set"].forEach(i => document.getElementById("tab-" + i).style.display = "none");
        document.getElementById("tab-" + t).style.display = "block";
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        if (el) el.classList.add("active");
        if (t === "att") render();
      }

      function register() {
        const n = document.getElementById("reg-n").value, ph = document.getElementById("reg-ph").value;
        if (!n || !ph) return alert("Fill data.");
        const id = `${cs}-${(db.students.filter(s => s.subject === cs).length + 1).toString().padStart(3, "0")}`;
        db.students.push({ id, name: n, phone: ph, grade: cg, subject: cs });
        saveDB();
        alert("Synced to Cloud!");
        document.getElementById("reg-n").value = "";
        document.getElementById("reg-ph").value = "";
      }

      function render() {
        const dateInput = document.getElementById("att-date").value;
        const date = dateInput || new Date().toISOString().split("T")[0];
        if(!dateInput) document.getElementById("att-date").value = date;

        const q = document.getElementById("att-q").value.toLowerCase();
        const students = db.students.filter(s => s.grade === cg && s.subject === cs && s.name.toLowerCase().includes(q));
        const attData = db.att[cs + cg + date] || { present: [], absent: [] };

        document.getElementById("dom-list").innerHTML = students.map(s => {
          const isP = attData.present.includes(s.id);
          return `<div class="std-row">
            <div><b>${s.name}</b><br><small>${s.id}</small></div>
            <input type="checkbox" style="width:30px; height:30px;" ${isP ? "checked" : ""} onchange="mark('${s.id}', this)">
          </div>`;
        }).join("");
      }

      function mark(id, chk) {
        const date = document.getElementById("att-date").value;
        const key = cs + cg + date;
        if (!db.att[key]) db.att[key] = { present: [], absent: [] };
        if (chk.checked) {
          if (!db.att[key].present.includes(id)) db.att[key].present.push(id);
        } else {
          db.att[key].present = db.att[key].present.filter(x => x !== id);
        }
        saveDB();
      }

      function saveBulkAttendance() {
        const date = document.getElementById("att-date").value;
        const key = cs + cg + date;
        if (!db.att[key]) db.att[key] = { present: [], absent: [] };
        const students = db.students.filter(s => s.grade === cg && s.subject === cs);
        db.att[key].absent = students.filter(s => !db.att[key].present.includes(s.id)).map(s => s.id);
        saveDB();
        alert("Cloud Record Updated!");
      }

      function openSummaryWindow() {
        const date = document.getElementById("att-date").value;
        const key = cs + cg + date;
        const att = db.att[key] || { present: [], absent: [] };
        const ss = db.students.filter(s => s.grade === cg && s.subject === cs);
        let total = 0;
        let html = `<table id="report-table" style="width:100%; border-collapse: collapse; font-size: 0.9rem;"><thead><tr style="background:#eee"><th>Name</th><th>Status</th><th>Fee</th></tr></thead><tbody>`;
        ss.forEach(s => {
          const isP = att.present.includes(s.id);
          const amt = isP ? 1000 : 0;
          total += amt;
          html += `<tr style="border-bottom:1px solid #eee"><td>${s.name}</td><td class="${isP ? 'status-p' : 'status-a'}">${isP ? 'P' : 'A'}</td><td>${amt}</td></tr>`;
        });
        html += `</tbody></table>`;
        const inst = total * 0.2;
        document.getElementById("sum-table-area").innerHTML = html;
        document.getElementById("fin-box").innerHTML = `Total: Rs.${total} <br> Institute (20%): Rs.${inst} <hr> <b>Teacher Fee: Rs.${total - inst}</b>`;
        document.getElementById("s-overlay").style.display = "block";
      }

      async function shareSummary() {
        const doc = new jspdf.jsPDF();
        doc.text("SIPSAYURA DAILY REPORT", 10, 10);
        doc.autoTable({ html: "#report-table", startY: 20 });
        doc.save(`Sipsayura_Report_${cg}_${cs}.pdf`);
      }

      init();
    </script>
  </body>
</html>
